@rendermode InteractiveServer
@page "/exhibits/{id:guid}"
@attribute [Authorize]

@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.EntityFrameworkCore
@using VirtualMuseum.Models
@using VirtualMuseum.Services
@using Track3.Components.Data
@using Track3.Components.Models

@inject IExhibitService ExhibitService
@inject AppDbContext Db
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Nav

<h3>Описание экспоната</h3>

@if (exhibit == null)
{
    <p>Экспонат не найден.</p>
}
else
{
    <div class="exhibit-details">
        @if (!string.IsNullOrWhiteSpace(exhibit.ImagePath))
        {
            <img src="@exhibit.ImagePath" class="exhibit-image" />
        }

        <div class="exhibit-details-info">
            <h2>@exhibit.Name</h2>

            @if (!string.IsNullOrWhiteSpace(exhibit.Era))
            {
                <p class="exhibit-era">@exhibit.Era</p>
            }

            @if (!string.IsNullOrWhiteSpace(exhibit.Author))
            {
                <p class="exhibit-author">@exhibit.Author</p>
            }

            <p>@exhibit.Description</p>

            @if (exhibit.Latitude.HasValue && exhibit.Longitude.HasValue)
            {
                <div class="exhibit-coords">
                    Координаты на карте: @exhibit.Latitude:F2; @exhibit.Longitude:F2
                </div>
            }

            <div class="visit-status">
                @if (visited)
                {
                    <span class="visited-badge">Этот экспонат уже посещён вами</span>
                }
                else
                {
                    <button class="visit-button" @onclick="MarkVisited">
                        Отметить как посещённый
                    </button>
                }
            </div>

            @if (!string.IsNullOrWhiteSpace(visitToast))
            {
                <div class="toast-popup">@visitToast</div>
            }

            <a href="/exhibits" class="back-link">← Назад к списку</a>
        </div>
    </div>

    <hr />

    <h4>Оставить отзыв</h4>

    <div class="feedback-form">
        <div class="feedback-row">
            <input class="feedback-input"
                   placeholder="Ваше имя (необязательно)"
                   @bind="feedbackName" />
        </div>

        <div class="feedback-row">
            <textarea class="feedback-textarea"
                      placeholder="Ваш отзыв"
                      @bind="feedbackMessage"></textarea>
        </div>

        <button type="button"
                class="feedback-button"
                @onclick="OnSendClick">
            Отправить
        </button>
    </div>

    @if (showToast)
    {
        <div class="toast-popup">
            Ваш отзыв успешно отправлен!
        </div>
    }
}

<style>
    .exhibit-image {
        width: 100%;
        max-width: 900px;
        height: auto;
        display: block;
        object-fit: contain;
        border-radius: 16px;
        box-shadow: 0 10px 24px rgba(0,0,0,0.4);
        margin: 10px 0 16px;
    }
</style>

@code {
    [Parameter] public Guid id { get; set; }

    private Exhibit? exhibit;

    private bool visited;
    private string? visitToast;

    private string? feedbackName;
    private string? feedbackMessage;
    private bool showToast;

    protected override async Task OnInitializedAsync()
    {
        exhibit = await ExhibitService.GetAsync(id);
        await LoadVisited();
    }

    private async Task LoadVisited()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated != true || exhibit == null)
            return;

        var uidStr = user.FindFirst("uid")?.Value;
        if (!int.TryParse(uidStr, out var uid))
            return;

        visited = await Db.VisitedExhibits
            .AnyAsync(v => v.UserId == uid && v.ExhibitId == exhibit.Id);
    }

    private async Task MarkVisited()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated != true || exhibit == null)
        {
            Nav.NavigateTo("/login", forceLoad: true);
            return;
        }

        var uidStr = user.FindFirst("uid")?.Value;
        if (!int.TryParse(uidStr, out var uid))
            return;

        visited = await Db.VisitedExhibits
            .AnyAsync(v => v.UserId == uid && v.ExhibitId == exhibit.Id);

        var exists = await Db.VisitedExhibits
            .AnyAsync(v => v.UserId == uid && v.ExhibitId == exhibit.Id);

        if (!exists)
        {
            Db.VisitedExhibits.Add(new VisitedExhibit
            {
                UserId = uid,
                ExhibitId = exhibit.Id,
                VisitedAtUtc = DateTime.UtcNow
            });

            await Db.SaveChangesAsync();
        }

        visited = true;

        visitToast = "Добавлено в посещённые ✅";
        StateHasChanged();
        await Task.Delay(1500);
        visitToast = null;
        StateHasChanged();
    }

    private async Task OnSendClick()
    {
        if (string.IsNullOrWhiteSpace(feedbackMessage))
            return;

        showToast = true;
        StateHasChanged();

        await Task.Delay(2000);

        showToast = false;
        StateHasChanged();

        feedbackName = string.Empty;
        feedbackMessage = string.Empty;
    }
}
