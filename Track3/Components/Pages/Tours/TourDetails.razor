@rendermode InteractiveServer
@page "/tours/{id:guid}"
@attribute [Authorize]

@using Microsoft.AspNetCore.Authorization
@using VirtualMuseum.Models
@using VirtualMuseum.Services
@inject ITourService TourService
@inject IExhibitService ExhibitService
@inject NavigationManager Nav

@if (tour == null)
{
    <h3>Тур не найден</h3>
    <a href="/tours" class="back-link">← Назад к списку туров</a>
}
else
{
    <h3>@tour.Title</h3>

    <div class="tour-details">
        <div class="tour-details-main">
            <p class="tour-desc">@tour.Description</p>

            <div class="tour-meta">
                @if (tour.StartTime.HasValue)
                {
                    <div><b>Начало:</b> @tour.StartTime.Value.ToString("f")</div>
                }
                @if (tour.Duration.HasValue)
                {
                    <div><b>Длительность:</b> @tour.Duration.Value.TotalMinutes.ToString("0") мин</div>
                }
                <div><b>Экспонатов в туре:</b> @tour.ExhibitIds.Count</div>
            </div>

            <button class="tour-button-danger" @onclick="DeleteTour">
                Удалить тур
            </button>

            <a href="/tours" class="back-link">← Назад к списку туров</a>
        </div>

        <div class="tour-details-exhibits">
            <h4>Экспонаты в этом туре</h4>

            @if (!exhibits.Any())
            {
                <p>В этот тур пока не добавлено ни одного экспоната.</p>
            }
            else
            {
                <ul class="tour-exhibit-list">
                    @foreach (var ex in exhibits)
                    {
                        <li>
                            <a href="/exhibits/@ex.Id">@ex.Name</a>
                            <span class="tour-exhibit-era">@ex.Era</span>
                        </li>
                    }
                </ul>
            }
        </div>
    </div>
}

@code {
    [Parameter] public Guid id { get; set; }

    private Tour? tour;
    private List<Exhibit> exhibits = new();

    protected override async Task OnInitializedAsync()
    {
        tour = await TourService.GetAsync(id);

        if (tour != null && tour.ExhibitIds != null && tour.ExhibitIds.Any())
        {
            var all = (await ExhibitService.GetAllAsync()).ToList();
            var dict = all.ToDictionary(e => e.Id, e => e);

            foreach (var exId in tour.ExhibitIds)
            {
                if (dict.TryGetValue(exId, out var ex))
                    exhibits.Add(ex);
            }
        }
    }

    private async Task DeleteTour()
    {
        if (tour == null)
            return;

        await TourService.DeleteAsync(tour.Id);
        Nav.NavigateTo("/tours");
    }
}
