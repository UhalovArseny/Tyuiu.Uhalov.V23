@rendermode InteractiveServer
@page "/tours/{id:guid}"

@using VirtualMuseum.Models
@using VirtualMuseum.Services
@inject ITourService TourService
@inject IExhibitService ExhibitService
@inject NavigationManager Nav

<h3>Информация о туре</h3>

@if (tour == null)
{
    <p>Тур не найден.</p>
}
else
{
    <div class="tour-details">
        <div class="tour-details-main">
            <h2>@tour.Title</h2>
            <p class="tour-desc">@tour.Description</p>

            <div class="tour-meta">
                @if (tour.StartTime.HasValue)
                {
                    <div><b>Начало:</b> @tour.StartTime.Value.ToString("f")</div>
                }
                @if (tour.Duration.HasValue)
                {
                    <div><b>Длительность:</b> @tour.Duration.Value.TotalMinutes.ToString("0") мин</div>
                }
            </div>

            <button class="tour-button-danger" @onclick="DeleteTour">
                Удалить тур
            </button>

            <a href="/tours" class="back-link">← Назад к списку туров</a>
        </div>

        <div class="tour-details-exhibits">
            <h4>Экспонаты в туре</h4>

            @if (tourExhibits == null || !tourExhibits.Any())
            {
                <p>В этот тур пока не добавлено ни одного экспоната.</p>
            }
            else
            {
                <ul class="tour-exhibit-list">
                    @foreach (var ex in tourExhibits)
                    {
                        <li>
                            <a href="/exhibits/@ex.Id">@ex.Name</a>
                            <span class="tour-exhibit-era">@ex.Era</span>
                        </li>
                    }
                </ul>
            }
        </div>
    </div>
}

@code {
    [Parameter] public Guid id { get; set; }

    private Tour? tour;
    private List<Exhibit> tourExhibits = new();

    protected override async Task OnInitializedAsync()
    {
        tour = await TourService.GetAsync(id);
        await LoadExhibits();
    }

    private async Task LoadExhibits()
    {
        tourExhibits.Clear();

        if (tour?.ExhibitIds != null && tour.ExhibitIds.Any())
        {
            var all = await ExhibitService.GetAllAsync();
            var dict = all.ToDictionary(e => e.Id, e => e);

            foreach (var exId in tour.ExhibitIds)
            {
                if (dict.TryGetValue(exId, out var ex))
                    tourExhibits.Add(ex);
            }
        }
    }

    private async Task DeleteTour()
    {
        if (tour == null)
            return;

        await TourService.DeleteAsync(tour.Id);
        Nav.NavigateTo("/tours");
    }
}
